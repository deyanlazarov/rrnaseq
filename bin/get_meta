#!/usr/bin/env Rscript
#./get_meta -i mapstats.tab -o meta.rds

###
#Get opt
###
library('getopt')

argv = commandArgs(trailingOnly = F)  
scriptPath = dirname(sub("--file=", "", argv[grep("--file", argv)]))
#source(file.path(scriptPath, '../lib/getopt.R')) #If one wants to avoid dependency of installed R package (getopt).
argv = commandArgs(trailingOnly = T)

spec = matrix(c(
  'mapstats.tab.file', 'i', 1, 'character',
  'meta.file', 'o', 1, 'character',
  'meta.tab.file', 't', 1, 'character',
  'lib.dir', 'l', 1, 'character',
  'help', 'h', 0, 'logical'
), byrow=TRUE, ncol=4);
opt = getopt(spec)

usage <- function(spec){
  cat(getopt(spec, command = 'get_meta', usage=TRUE));
  cat(sprintf(" -i mapstats.tab.file\n\tInput file, containing mapping statistics in tab-separated columns. This file can be generated by running \"make_summary_starlog.pl\".\n"))
  cat(sprintf(" -o meta.file\n\tOutput file in rds-format, containing the same data as the input file, but with a few added columns: 'id', 'nostrat', 'id.color', 'nostrat.color'. Default: meta.rds\n"))
  cat(sprintf(" -t meta.tab.file\n\tOutput file in tab-format, but same contents as meta.file. Default: meta.tab\n"))
  cat(sprintf(" -l lib.dir\n\tLibrary directory with required R functions. Default: A subdir residing at '../lib' relative to where this program was executed from.\n\n"))
  q(status=1);
}

#Print usage if help flag set
if(!is.null(opt[['help']])){
  usage(spec)
}

#Error check that all required options were set
if(is.null(opt[['mapstats.tab.file']])){warning('Error: "i" is a required option'); usage(spec);}

#Set defaults for optional options
if(is.null(opt[['meta.file']])){opt[['meta.file']] = 'meta.rds';}
if(is.null(opt[['meta.tab.file']])){opt[['meta.tab.file']] = 'meta.tab';}
if(is.null(opt[['lib.dir']])){opt[['lib.dir']] = file.path(scriptPath, '../lib');}


###
#Source fcn libs
###
source(file.path(opt[['lib.dir']], 'expr.lib.R'), chdir = TRUE)
source(file.path(opt[['lib.dir']], 'main.lib.R'), chdir = TRUE)


###
#Execute
###
get.meta(opt[['mapstats.tab.file']], opt[['meta.file']], opt[['meta.tab.file']])
